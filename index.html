<html>
<head>
	<title>Status Reporting App in React.js using Appbase </title>
	<script src="https://fb.me/react-0.13.3.js"></script>
	<script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
	<script src="bower_components/appbase-js/browser/appbase.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	 <!-- Compiled and minified CSS -->
  	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css">
	<!-- Compiled and minified JavaScript -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>
	<!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<link rel="stylesheet" type="text/css" href="css/style.css">

</head>
<body>
	<div id="container">
		<div class="row">
		<div id = "statusInput" class="col s12 m12 l12"> </div>
		<div id = "feed" class="col s12 m6 l6"> </div>	
	</div>
	<script type="text/jsx">

		var StatusInput = React.createClass({
		  componentDidMount: function() {
			this.refs.statusInput.getDOMNode().focus(); 
	   	  },
		  render: function () {

		    return (
		    	<div className="statusInput">
		    		<h2>What are you doing?</h2>
		    		<input type = "text" onKeyPress = {this._handleKeyPress} placeholder={this.props.placeholder} ref="statusInput" />
		    	</div>
		    )

		  },
		  _handleKeyPress: function(e) {
		    if (e.key === 'Enter') {
		      console.log('Enter pressed!');
		      this.props.onSubmit(this.refs.statusInput.getDOMNode().value);
		      this.refs.statusInput.getDOMNode().value = "";
		    }
		  }
		});

		var TwitterInput = React.createClass({
		  componentDidMount: function() {
			this.refs.nameInput.getDOMNode().focus(); 
	   	  },
		  render: function () {

		    return (
		    	<div className="statusInput">
		    		<h2>What is your Twitter username?</h2>
		    		<input type = "text" onKeyPress = {this._handleKeyPress} placeholder="@YourTwitterUsername" ref="nameInput" />
		    	</div>
		    )

		  },
		  _handleKeyPress: function(e) {
		    if (e.key === 'Enter') {
		      this.props.onSubmit(this.refs.nameInput.getDOMNode().value);
		    }
		  }
		});

		
		var StreamBrowser = React.createClass({

			// Set the initial props
			getDefaultProps: function() {
				return {
					app_name: 'workingon',
					username: 'iiyvFcb3A',
					password: 'b3a36a4d-e517-451c-a04f-a11dc2c4b4bc',
					type: 'feed'
				};
			},

			// Set the initial component state
			getInitialState: function(){
				console.log(localStorage.state);
				if (localStorage.state){
					status = JSON.parse(localStorage.state).status
					twitterHandle = JSON.parse(localStorage.state).twitterHandle

				}
				else
				{
					status = "Mining Bitcoin"
					twitterHandle = ""
				}
				return {
					status: status,
					twitterHandle: twitterHandle
				};
			},
			componentDidUpdate: function(prevProps, prevState) {
			    localStorage.state = JSON.stringify(this.state);
			    console.log("Ab gaya idhar")
			},
			addStatus: function(status){
				console.log("Status Added!");
				this.setState({
					status:status 
				});
				var data = {
					"status": status,
					"twitterHandle": this.state.twitterHandle
				}
				console.log(data)
  		  		$.ajax({
					type: "POST",
					xhrFields: {
					  withCredentials: true
					},
					headers: {
					  "Authorization": "Basic " + btoa(this.props.username+':'+this.props.password)
					},
					data: JSON.stringify(data),
					url: 'http://scalr.api.appbase.io/'+this.props.app_name+ '/' + this.props.type+'/',
					dataType: 'json',
					contentType: "application/json",

					success: function(data) {
						console.log(data);
					}.bind(this),
					error: function(xhr, status, err) {
						console.error(status, err.toString());
						console.log(data)
					}.bind(this)
				});
		  	},

		  	addTwitterHandle: function(twitterHandle){
		  		this.setState({
					twitterHandle: twitterHandle 
				});
				console.log("Twitter handle aded")
		  	},

			render: function() {
				var twitterHandle = ""
				if(localStorage.state)
					twitterHandle = JSON.parse(localStorage.state).twitterHandle
				if(twitterHandle || this.state.twitterHandle){
					console.log(this.TwitterHandle)
					return (
						<StatusInput onSubmit={this.addStatus} placeholder={this.state.status}/>
					);					
				}
				else{
					console.log(localStorage)
					return (
						<TwitterInput onSubmit={this.addTwitterHandle} />
					);
				}
			}
		
		});
		
		React.render(
		  <StreamBrowser />,
		  document.getElementById('statusInput')
		);
	</script>

</body>
</html>