<html>
<head>
	<title>Status Reporting App in React.js using Appbase </title>
	<script src="https://fb.me/react-0.13.3.js"></script>
	<script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
	<script src="bower_components/appbase-js/browser/appbase.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
	<div id="container">
	</div>
	<script type="text/jsx">

		var Input = React.createClass({
		  componentDidMount: function() {
			this.refs.statusInput.getDOMNode().focus(); 
	   	  },
		  render: function () {
		    return (
		    	<div className="statusInput">
		    		<h1>What are you doing?</h1>
		    		<input type = "text" onKeyPress = {this._handleKeyPress} placeholder={this.props.placeholder} ref="statusInput" />
		    	</div>
		    )

		  },
		  _handleKeyPress: function(e) {
		    if (e.key === 'Enter') {
		      console.log('Enter pressed!');
		      this.props.onSubmit(this.refs.statusInput.getDOMNode().value);
		      this.refs.statusInput.getDOMNode().value = "";
		    }
		  }
		});
		
		var StreamBrowser = React.createClass({

			// Set the initial props
			getDefaultProps: function() {
				return {
					app_name: 'workingon',
					username: 'iiyvFcb3A',
					password: 'b3a36a4d-e517-451c-a04f-a11dc2c4b4bc',
					type: 'feed'
				};
			},

			// Set the initial component state
			getInitialState: function(){
				console.log(localStorage.state);
				if (localStorage.state){
					status = JSON.parse(localStorage.state).status
				}
				else
				{
					status = "Skiing in Chicago"
				}
				return {
					status: status
				};
			},
			componentDidUpdate: function(prevProps, prevState) {
			    localStorage.state = JSON.stringify(this.state);
			},
			addStatus: function(status){
				console.log("Status Added!");
				this.setState({
					status:status 
				});
				var data = {
					"status": status
				}
  		  		$.ajax({
					type: "POST",
					xhrFields: {
					  withCredentials: true
					},
					headers: {
					  "Authorization": "Basic " + btoa(this.props.username+':'+this.props.password)
					},
					data: JSON.stringify(data),
					url: 'http://scalr.api.appbase.io/'+this.props.app_name+ '/' + this.props.type+'/',
					dataType: 'json',
					contentType: "application/json",

					success: function(data) {
						console.log(data);
					}.bind(this),
					error: function(xhr, status, err) {
						console.error(status, err.toString());
						console.log(data)
					}.bind(this)
				});
		  	},

			render: function() {
				return (
					<Input onSubmit={this.addStatus} placeholder={this.state.status}/>
				);
			}
		
		});
		
		React.render(
		  <StreamBrowser />,
		  document.getElementById('container')
		);
	</script>

</body>
</html>